#!/bin/bash

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Vulnerability scanning functions
web_vulnerability_scan() {
    echo -e "\n${YELLOW}[*] Starting web vulnerability scanning...${NC}"
    
    for host in $(cat live_hosts.txt); do
        echo -e "${BLUE}[*] Checking web services on $host${NC}"
        
        # Check for HTTP services
        if grep -q "80/open" "scan_$host.txt" || grep -q "443/open" "scan_$host.txt" || grep -q "8080/open" "scan_$host.txt"; then
            echo -e "${YELLOW}[*] Web services found on $host${NC}"
            
            # Run Nikto scan
            if [ -d "nikto" ]; then
                echo -e "${BLUE}[*] Running Nikto scan...${NC}"
                cd nikto/program
                perl nikto.pl -h $host -o "../nikto_$host.html"
                cd ../..
            fi
            
            # Run WhatWeb
            if [ -d "WhatWeb" ]; then
                echo -e "${BLUE}[*] Running WhatWeb...${NC}"
                cd WhatWeb
                ./whatweb $host -v > "../whatweb_$host.txt"
                cd ..
            fi
        fi
    done
}

sql_injection_test() {
    echo -e "\n${YELLOW}[*] Testing for SQL injection vulnerabilities...${NC}"
    
    if [ -d "sqlmap" ]; then
        for host in $(cat live_hosts.txt); do
            # Test common web paths (you should modify these)
            URLS=("http://$host" "https://$host" "http://$host:8080")
            
            for url in "${URLS[@]}"; do
                echo -e "${BLUE}[*] Testing $url with SQLMap${NC}"
                cd sqlmap
                python sqlmap.py -u "$url" --batch --crawl=2 --level=1 > "../sqlmap_$host.txt"
                cd ..
            done
        done
    fi
}

ssl_vulnerability_check() {
    echo -e "\n${YELLOW}[*] Checking SSL/TLS vulnerabilities...${NC}"
    
    for host in $(cat live_hosts.txt); do
        # Test SSL on common ports
        for port in 443 8443 993 995; do
            if grep -q "$port/open" "scan_$host.txt"; then
                echo -e "${BLUE}[*] Testing SSL on $host:$port${NC}"
                nmap --script ssl-enum-ciphers,ssl-cert,ssl-heartbleed -p $port $host -oN "ssl_$host_$port.txt"
            fi
        done
    done
}

nmap_vulnerability_scan() {
    echo -e "\n${YELLOW}[*] Running Nmap vulnerability scripts...${NC}"
    
    for host in $(cat live_hosts.txt); do
        echo -e "${BLUE}[*] Vulnerability scan for $host${NC}"
        
        # Run common vulnerability scripts
        nmap --script vuln --script-args=unsafe=1 $host -oN "vuln_scan_$host.txt"
        
        # Run exploit scripts
        nmap --script exploit $host -oN "exploit_scan_$host.txt"
    done
}

generate_report() {
    echo -e "\n${YELLOW}[*] Generating vulnerability report...${NC}"
    
    REPORT="vulnerability_report_$(date +%Y%m%d_%H%M%S).txt"
    
    echo "VULNERABILITY SCAN REPORT" > $REPORT
    echo "Generated: $(date)" >> $REPORT
    echo "=========================" >> $REPORT
    
    for host in $(cat live_hosts.txt); do
        echo -e "\nHOST: $host" >> $REPORT
        echo "==================" >> $REPORT
        
        # Add open ports
        if [ -f "scan_$host.txt" ]; then
            echo "OPEN PORTS:" >> $REPORT
            grep -E "[0-9]+/.*open" "scan_$host.txt" >> $REPORT
        fi
        
        # Add vulnerabilities found
        if [ -f "vuln_scan_$host.txt" ]; then
            echo -e "\nVULNERABILITIES:" >> $REPORT
            grep -E "(VULNERABLE|CVE-|CRITICAL)" "vuln_scan_$host.txt" >> $REPORT
        fi
    done
    
    echo -e "${GREEN}[+] Vulnerability report saved as: $REPORT${NC}"
}

main() {
    echo -e "${BLUE}"
    echo "╔══════════════════════════════════════╗"
    echo "║        Vulnerability Scanner        ║"
    echo "║            Termux Edition           ║"
    echo "╚══════════════════════════════════════╝"
    echo -e "${NC}"
    
    if [ ! -f "live_hosts.txt" ]; then
        echo -e "${RED}[!] No live hosts found. Run network scan first.${NC}"
        echo -e "${YELLOW}[*] Run: ./scan_network.sh${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}"
    echo "Select vulnerability scan:"
    echo "1) Web Application Scan"
    echo "2) SQL Injection Test"
    echo "3) SSL/TLS Check"
    echo "4) Full Vulnerability Scan"
    echo "5) Generate Report Only"
    echo -e "${NC}"
    
    read -p "Enter choice (1-5): " choice
    
    case $choice in
        1)
            web_vulnerability_scan
            ;;
        2)
            sql_injection_test
            ;;
        3)
            ssl_vulnerability_check
            ;;
        4)
            web_vulnerability_scan
            sql_injection_test
            ssl_vulnerability_check
            nmap_vulnerability_scan
            ;;
        5)
            generate_report
            ;;
        *)
            echo -e "${RED}[!] Invalid choice${NC}"
            exit 1
            ;;
    esac
    
    generate_report
    echo -e "\n${GREEN}[+] Vulnerability scanning complete!${NC}"
}

main
